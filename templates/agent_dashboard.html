<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agent Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; }
    .message-container { max-height: 70vh; overflow-y: auto; }
    .user-message { background-color: #e2e8f0; border-radius: 8px; padding: 8px; margin-bottom: 8px; }
    .agent-message { background-color: #bfecde; border-radius: 8px; padding: 8px; margin-bottom: 8px; text-align: right; }
    .user-id-header { font-weight: bold; color: #4a5568; margin-bottom: 4px; }
    .timestamp { font-size: 0.75em; color: #718096; text-align: right; margin-top: 4px; }
    #replyForm { display: none; } /* Hidden by default */
  </style>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-3xl font-bold mb-6">üßë‚Äçüíª Customer Agent Dashboard</h1>

  <div class="flex space-x-6">
    <!-- Conversation List -->
    <div class="w-1/3 bg-white rounded shadow p-4">
      <h2 class="text-xl font-semibold mb-4">üí¨ Ongoing Conversations</h2>
      <div id="conversationList" class="space-y-4">
        <!-- Conversations will be loaded here -->
        <p class="text-gray-500" id="noConversations">No active conversations.</p>
      </div>
    </div>

    <!-- Chat Window -->
    <div class="w-2/3 bg-white rounded shadow p-4">
      <h2 class="text-xl font-semibold mb-4" id="chatTitle">Select a conversation</h2>
      <div id="chatWindow" class="message-container border border-gray-200 rounded p-4 mb-4">
        <!-- Messages for selected conversation -->
      </div>

      <!-- Reply Form -->
      <form id="replyForm" class="flex items-center space-x-2">
        <input type="hidden" id="currentReceiverId" name="receiver_viber_id">
        <input type="text" id="replyMessage" name="message_text" placeholder="Type your reply..." class="flex-grow border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Send</button>
        <button type="button" id="endChatButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">End Chat</button>
      </form>
    </div>
  </div>

  <script>
    const conversationList = document.getElementById('conversationList');
    const chatWindow = document.getElementById('chatWindow');
    const replyForm = document.getElementById('replyForm');
    const currentReceiverId = document.getElementById('currentReceiverId');
    const replyMessageInput = document.getElementById('replyMessage');
    const chatTitle = document.getElementById('chatTitle');
    const endChatButton = document.getElementById('endChatButton');
    const noConversationsMessage = document.getElementById('noConversations');

    let activeConversations = {}; // {viber_id: [{sender: 'user/agent', text: '...', timestamp: '...'}]}
    let currentSelectedViberId = null;

    // Function to render messages in the chat window
    function renderChatWindow(viberId) {
      chatWindow.innerHTML = '';
      if (activeConversations[viberId]) {
        activeConversations[viberId].forEach(msg => {
          const msgDiv = document.createElement('div');
          const isAgent = msg.sender === 'agent';
          msgDiv.className = isAgent ? 'agent-message' : 'user-message';
          msgDiv.innerHTML = `
            <div class="text-sm ${isAgent ? 'text-gray-600' : 'font-semibold'}">
              ${isAgent ? 'Agent' : `User (${msg.sender_id})`}
            </div>
            <div class="text-gray-800">${msg.text}</div>
            <div class="timestamp">${new Date(msg.timestamp).toLocaleString()}</div>
          `;
          chatWindow.appendChild(msgDiv);
        });
        chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom
      }
    }

    // Function to render conversation list
    function renderConversationList() {
      conversationList.innerHTML = '';
      let hasConversations = false;
      for (const viberId in activeConversations) {
        hasConversations = true;
        const lastMessage = activeConversations[viberId][activeConversations[viberId].length - 1];
        const convDiv = document.createElement('div');
        convDiv.className = `p-3 border rounded cursor-pointer ${viberId === currentSelectedViberId ? 'bg-blue-100 border-blue-500' : 'hover:bg-gray-50'}`;
        convDiv.innerHTML = `
          <div class="font-bold">User ID: ${viberId}</div>
          <div class="text-sm text-gray-600 truncate">${lastMessage ? lastMessage.text : ''}</div>
        `;
        convDiv.onclick = () => {
          currentSelectedViberId = viberId;
          currentReceiverId.value = viberId;
          chatTitle.textContent = `Chat with User: ${viberId}`;
          replyForm.style.display = 'flex'; // Show reply form
          renderChatWindow(viberId);
          renderConversationList(); // Re-render to highlight selected
        };
        conversationList.appendChild(convDiv);
      }
      noConversationsMessage.style.display = hasConversations ? 'none' : 'block';
      if (!hasConversations) {
        replyForm.style.display = 'none'; // Hide form if no conversations
        chatTitle.textContent = 'Select a conversation';
      }
    }

    // SSE Event Listener
    const eventSource = new EventSource('/agent_dashboard/stream');

    eventSource.onmessage = function(event) {
      const data = JSON.parse(event.data);
      console.log('Received SSE:', data);

      if (data.type === 'new_message') {
        const viberId = data.sender_id;
        if (!activeConversations[viberId]) {
          activeConversations[viberId] = [];
        }
        activeConversations[viberId].push({
          sender: 'user',
          sender_id: viberId, // Store sender_id for display
          text: data.message_text,
          timestamp: data.timestamp
        });
        
        renderConversationList();
        if (viberId === currentSelectedViberId) {
          renderChatWindow(viberId);
        }
      } else if (data.type === 'conversation_ended') {
        const viberId = data.viber_id;
        if (activeConversations[viberId]) {
          delete activeConversations[viberId];
          if (currentSelectedViberId === viberId) {
            currentSelectedViberId = null;
            chatWindow.innerHTML = '';
            chatTitle.textContent = 'Select a conversation';
            replyForm.style.display = 'none';
          }
          renderConversationList();
          alert(`Conversation with user ${viberId} has ended.`);
        }
      }
    };

    eventSource.onerror = function(err) {
      console.error("EventSource failed:", err);
      eventSource.close();
    };

    // Handle form submission for replies
    replyForm.onsubmit = async (e) => {
      e.preventDefault();
      const messageText = replyMessageInput.value;
      const receiverViberId = currentReceiverId.value;

      if (!messageText || !receiverViberId) return;

      try {
        const response = await fetch('/agent_dashboard/send_message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            receiver_viber_id: receiverViberId,
            message_text: messageText
          })
        });

        if (response.ok) {
          // Add agent's message to active conversation for display
          if (!activeConversations[receiverViberId]) {
            activeConversations[receiverViberId] = [];
          }
          activeConversations[receiverViberId].push({
            sender: 'agent',
            sender_id: 'Agent', // Agent's own ID
            text: messageText,
            timestamp: new Date().toISOString()
          });
          renderChatWindow(receiverViberId);
          replyMessageInput.value = ''; // Clear input
        } else {
          alert('Failed to send message.');
        }
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Error sending message.');
      }
    };

    // Handle End Chat button
    endChatButton.onclick = async () => {
      if (!currentSelectedViberId) return;
      if (!confirm(`Are you sure you want to end the chat with ${currentSelectedViberId}?`)) return;

      try {
        const response = await fetch('/agent_dashboard/end_chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ viber_id: currentSelectedViberId })
        });

        if (response.ok) {
          // SSE will handle removing it from activeConversations, but we can do it locally too
          delete activeConversations[currentSelectedViberId];
          currentSelectedViberId = null;
          chatWindow.innerHTML = '';
          chatTitle.textContent = 'Select a conversation';
          replyForm.style.display = 'none';
          renderConversationList();
          alert('Chat ended successfully.');
        } else {
          alert('Failed to end chat.');
        }
      } catch (error) {
        console.error('Error ending chat:', error);
        alert('Error ending chat.');
      }
    };

    // Initial render
    renderConversationList();

  </script>
</body>
  </html>
